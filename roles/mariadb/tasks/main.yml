---
# tasks file for mariadb
# Purpose: Database automation per domain

- name: Install MariaDB server
  ansible.builtin.dnf:
    name:
      - mariadb-server
      - mariadb
      - python3-PyMySQL
    state: present
  tags: [mariadb, install]

- name: Enable and start MariaDB service
  ansible.builtin.systemd:
    name: mariadb
    state: started
    enabled: yes
  tags: [mariadb, service]

- name: Check if MariaDB root password is set
  ansible.builtin.command: mysql -u root -e "SELECT 1"
  register: mysql_root_check
  changed_when: false
  failed_when: false
  tags: [mariadb, security]

- name: Set MariaDB root password
  community.mysql.mysql_user:
    name: root
    password: "{{ mariadb_root_password }}"
    login_unix_socket: /var/lib/mysql/mysql.sock
    state: present
  when: mysql_root_check.rc == 0
  no_log: true
  tags: [mariadb, security]

- name: Create /root/.my.cnf with root credentials
  ansible.builtin.template:
    src: my.cnf.j2
    dest: /root/.my.cnf
    owner: root
    group: root
    mode: '0600'
  no_log: true
  tags: [mariadb, security]

- name: Remove anonymous users
  community.mysql.mysql_user:
    name: ''
    host_all: yes
    state: absent
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  no_log: true
  tags: [mariadb, security]

- name: Remove test database
  community.mysql.mysql_db:
    name: test
    state: absent
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  tags: [mariadb, security]

- name: Disallow root login remotely
  community.mysql.mysql_query:
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    query: DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1')
  no_log: true
  tags: [mariadb, security]

- name: Create databases for each domain
  community.mysql.mysql_db:
    name: "{{ item.0.username }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}"
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    collation: utf8mb4_unicode_ci
    encoding: utf8mb4
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  tags: [mariadb, databases]

- name: Create databases for each subdomain
  community.mysql.mysql_db:
    name: "{{ item.0.username }}_{{ item.2 }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}"
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    collation: utf8mb4_unicode_ci
    encoding: utf8mb4
  loop: "{{ hosting_users | subelements('domains') | subelements('1.subdomains', skip_missing=True) }}"
  when: item.1.subdomains is defined and item.1.subdomains | length > 0
  tags: [mariadb, databases]

- name: Generate database passwords for main domains
  ansible.builtin.set_fact:
    domain_db_passwords: "{{ domain_db_passwords | default({}) | combine({ item.0.username + '_' + item.1.domain: lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }) }}"
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  no_log: true
  tags: [mariadb, users]

- name: Generate database passwords for subdomains
  ansible.builtin.set_fact:
    subdomain_db_passwords: "{{ subdomain_db_passwords | default({}) | combine({ item.0.username + '_' + item.2 + '_' + item.1.domain: lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }) }}"
  loop: "{{ hosting_users | subelements('domains') | subelements('1.subdomains', skip_missing=True) }}"
  when: item.1.subdomains is defined and item.1.subdomains | length > 0
  no_log: true
  tags: [mariadb, users]

- name: Create database users for main domains
  community.mysql.mysql_user:
    name: "{{ item.0.username }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') | truncate(16, True, '') }}"
    password: "{{ domain_db_passwords[item.0.username + '_' + item.1.domain] }}"
    priv: "{{ item.0.username }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}.*:ALL"
    host: localhost
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  no_log: true
  tags: [mariadb, users]

- name: Create database users for subdomains
  community.mysql.mysql_user:
    name: "{{ (item.0.username + '_' + item.2 + '_' + item.1.domain) | regex_replace('[^a-zA-Z0-9]', '_') | truncate(16, True, '') }}"
    password: "{{ subdomain_db_passwords[item.0.username + '_' + item.2 + '_' + item.1.domain] }}"
    priv: "{{ item.0.username }}_{{ item.2 }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}.*:ALL"
    host: localhost
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  loop: "{{ hosting_users | subelements('domains') | subelements('1.subdomains', skip_missing=True) }}"
  when: item.1.subdomains is defined and item.1.subdomains | length > 0
  no_log: true
  tags: [mariadb, users]

- name: Save database credentials to user home directories
  ansible.builtin.template:
    src: db-credentials.txt.j2
    dest: "/home/{{ item.0.username }}/db-credentials-{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}.txt"
    owner: "{{ item.0.username }}"
    group: "{{ item.0.username }}"
    mode: '0600'
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  tags: [mariadb, credentials]

- name: Save subdomain database credentials to user home directories
  ansible.builtin.template:
    src: db-credentials-subdomain.txt.j2
    dest: "/home/{{ item.0.username }}/db-credentials-{{ item.2 }}-{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}.txt"
    owner: "{{ item.0.username }}"
    group: "{{ item.0.username }}"
    mode: '0600'
  loop: "{{ hosting_users | subelements('domains') | subelements('1.subdomains', skip_missing=True) }}"
  when: item.1.subdomains is defined and item.1.subdomains | length > 0
  tags: [mariadb, credentials]

- name: Configure MariaDB for optimal performance
  ansible.builtin.template:
    src: mariadb-custom.cnf.j2
    dest: /etc/my.cnf.d/99-custom.cnf
    owner: root
    group: root
    mode: '0644'
  notify: restart mariadb
  tags: [mariadb, config]

- name: Configure firewall for MySQL (if needed for remote access)
  ansible.posix.firewalld:
    service: mysql
    permanent: yes
    state: "{{ mariadb_allow_remote | default(false) | ternary('enabled', 'disabled') }}"
    immediate: yes
  when: ansible_facts.services['firewalld.service'] is defined
  tags: [mariadb, firewall]
