---
# tasks file for mariadb
# Purpose: Database automation per domain with conditional logic
#
# CONDITIONAL FLAGS (set in group_vars or host_vars):
#   mariadb_create_databases  — default: false
#   mariadb_create_users      — default: false
#   mariadb_save_credentials  — default: false
#   mariadb_apply_config      — default: true
#   mariadb_allow_remote      — default: false
#
# ROOT CAUSE NOTE — subelements('1.subdomains') is not valid Ansible syntax.
# subelements() only accepts a top-level key name (string), not a dotted path
# into an already-expanded tuple.  The correct approach is to build a flat
# list with set_fact + Jinja2 for-loops BEFORE looping in a task.

# =============================================================================
# INSTALL & SERVICE
# =============================================================================

- name: Install MariaDB server
  ansible.builtin.dnf:
    name:
      - mariadb-server
      - mariadb
      - python3-PyMySQL
    state: present
  tags: [mariadb, install]

- name: Enable and start MariaDB service
  ansible.builtin.systemd:
    name: mariadb
    state: started
    enabled: yes
  tags: [mariadb, service]

# =============================================================================
# SECURITY HARDENING
# =============================================================================

- name: Check if MariaDB root password is already set
  ansible.builtin.command: mysql -u root -e "SELECT 1"
  register: mariadb_root_check
  changed_when: false
  failed_when: false
  tags: [mariadb, security]

- name: Set MariaDB root password (only when not yet set)
  community.mysql.mysql_user:
    name: root
    password: "{{ mariadb_root_password }}"
    login_unix_socket: /var/lib/mysql/mysql.sock
    state: present
  when: mariadb_root_check.rc == 0
  no_log: true
  tags: [mariadb, security]

- name: Deploy /root/.my.cnf for passwordless root CLI access
  ansible.builtin.template:
    src: my.cnf.j2
    dest: /root/.my.cnf
    owner: root
    group: root
    mode: '0600'
  no_log: true
  tags: [mariadb, security]

- name: Remove anonymous users
  community.mysql.mysql_user:
    name: ''
    host_all: yes
    state: absent
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  no_log: true
  tags: [mariadb, security]

- name: Remove test database
  community.mysql.mysql_db:
    name: test
    state: absent
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  tags: [mariadb, security]

- name: Disallow root login remotely
  community.mysql.mysql_query:
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    query: >
      DELETE FROM mysql.user
      WHERE User='root'
      AND Host NOT IN ('localhost', '127.0.0.1', '::1')
  no_log: true
  tags: [mariadb, security]

# =============================================================================
# BUILD FLAT SUBDOMAIN LIST
# =============================================================================
# subelements() cannot traverse a dotted path like '1.subdomains'.
# We build a flat list first, then loop over that list in every subdomain task.
# Each item in the resulting list is a dict with keys:
#   username  — owner's Linux username
#   domain    — parent domain string
#   subdomain — individual subdomain string
# This approach works regardless of the number of users, domains, or subdomains.

- name: Build flat list of all user + domain + subdomain combinations
  ansible.builtin.set_fact:
    mariadb_subdomain_list: >-
      {{
        mariadb_subdomain_list | default([]) +
        [{'username': user.username, 'domain': domain.domain, 'subdomain': sub}]
      }}
  loop: >-
    {{
      hosting_users
      | subelements('domains', skip_missing=True)
    }}
  vars:
    user: "{{ item.0 }}"
    domain: "{{ item.1 }}"
  # Only expand when this domain actually has subdomains
  when: item.1.subdomains is defined and item.1.subdomains | length > 0
  loop_control:
    label: "{{ item.0.username }} / {{ item.1.domain }}"
  tags: [mariadb, databases, users, credentials]

# Build a second flat loop using the per-domain subdomain list
- name: Expand subdomain list entries for each subdomain
  ansible.builtin.set_fact:
    mariadb_subdomain_flat: >-
      {{
        mariadb_subdomain_flat | default([]) +
        [{'username': item.0.username, 'domain': item.0.domain,
          'subdomain': sub}]
      }}
  loop: >-
    {{
      (mariadb_subdomain_list | default([]))
      | subelements('subdomain', skip_missing=True)
    }}
  vars:
    sub: "{{ item.1 }}"
  when: mariadb_subdomain_list is defined and mariadb_subdomain_list | length > 0
  loop_control:
    label: "{{ item.0.username }} / {{ item.0.domain }} / {{ item.1 }}"
  tags: [mariadb, databases, users, credentials]

# Simpler approach: build the flat list directly with a Jinja2 for-loop
- name: Build flat subdomain list using Jinja2 for-loop (primary method)
  ansible.builtin.set_fact:
    subdomain_entries: >-
      {%- set result = [] -%}
      {%- for user in hosting_users -%}
        {%- for domain in user.domains | default([]) -%}
          {%- for sub in domain.subdomains | default([]) -%}
            {%- set _ = result.append({
              'username':  user.username,
              'domain':    domain.domain,
              'subdomain': sub
            }) -%}
          {%- endfor -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ result }}
  tags: [mariadb, databases, users, credentials]

# =============================================================================
# DATABASE CREATION  (guarded by mariadb_create_databases flag)
# =============================================================================

- name: Show status — database creation
  ansible.builtin.debug:
    msg: >-
      mariadb_create_databases={{ mariadb_create_databases }}.
      {{ 'Databases WILL be created.' if mariadb_create_databases
         else 'Skipping. Set mariadb_create_databases: true to enable.' }}
  tags: [mariadb, databases]

- name: Create database for each main domain
  community.mysql.mysql_db:
    name: "{{ item.0.username }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}"
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    collation: utf8mb4_unicode_ci
    encoding: utf8mb4
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.username }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}"
  when: mariadb_create_databases | bool
  tags: [mariadb, databases]

# Use the pre-built flat list — no nested subelements needed
- name: Create database for each subdomain
  community.mysql.mysql_db:
    name: >-
      {{ item.username }}_{{ item.subdomain }}_{{ item.domain
         | regex_replace('[^a-zA-Z0-9]', '_') }}
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    collation: utf8mb4_unicode_ci
    encoding: utf8mb4
  loop: "{{ subdomain_entries }}"
  loop_control:
    label: "{{ item.username }}_{{ item.subdomain }}_{{ item.domain | regex_replace('[^a-zA-Z0-9]', '_') }}"
  when:
    - mariadb_create_databases | bool
    - subdomain_entries | length > 0
  tags: [mariadb, databases]

# =============================================================================
# USER CREATION  (guarded by mariadb_create_users flag)
# =============================================================================

- name: Show status — user creation
  ansible.builtin.debug:
    msg: >-
      mariadb_create_users={{ mariadb_create_users }}.
      {{ 'Users WILL be created.' if mariadb_create_users
         else 'Skipping. Set mariadb_create_users: true to enable.' }}
  tags: [mariadb, users]

- name: Generate database passwords for main domains
  ansible.builtin.set_fact:
    domain_db_passwords: >-
      {{ domain_db_passwords | default({}) | combine({
           item.0.username ~ '_' ~ item.1.domain:
             lookup('password', '/dev/null length=32 chars=ascii_letters,digits')
         }) }}
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.username }} / {{ item.1.domain }}"
  when: mariadb_create_users | bool
  no_log: true
  tags: [mariadb, users]

- name: Generate database passwords for subdomains
  ansible.builtin.set_fact:
    subdomain_db_passwords: >-
      {{ subdomain_db_passwords | default({}) | combine({
           item.username ~ '_' ~ item.subdomain ~ '_' ~ item.domain:
             lookup('password', '/dev/null length=32 chars=ascii_letters,digits')
         }) }}
  loop: "{{ subdomain_entries }}"
  loop_control:
    label: "{{ item.username }} / {{ item.subdomain }}.{{ item.domain }}"
  when:
    - mariadb_create_users | bool
    - subdomain_entries | length > 0
  no_log: true
  tags: [mariadb, users]

- name: Create database user for each main domain
  community.mysql.mysql_user:
    name: >-
      {{ (item.0.username ~ '_' ~ item.1.domain)
         | regex_replace('[^a-zA-Z0-9]', '_')
         | truncate(16, True, '') }}
    password: "{{ domain_db_passwords[item.0.username ~ '_' ~ item.1.domain] }}"
    priv: >-
      {{ item.0.username ~ '_' ~
         (item.1.domain | regex_replace('[^a-zA-Z0-9]', '_')) }}.*:ALL
    host: localhost
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.username }} / {{ item.1.domain }}"
  when:
    - mariadb_create_users | bool
    - domain_db_passwords is defined
  no_log: true
  tags: [mariadb, users]

- name: Create database user for each subdomain
  community.mysql.mysql_user:
    name: >-
      {{ (item.username ~ '_' ~ item.subdomain ~ '_' ~ item.domain)
         | regex_replace('[^a-zA-Z0-9]', '_')
         | truncate(16, True, '') }}
    password: "{{ subdomain_db_passwords[item.username ~ '_' ~ item.subdomain ~ '_' ~ item.domain] }}"
    priv: >-
      {{ item.username ~ '_' ~ item.subdomain ~ '_' ~
         (item.domain | regex_replace('[^a-zA-Z0-9]', '_')) }}.*:ALL
    host: localhost
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  loop: "{{ subdomain_entries }}"
  loop_control:
    label: "{{ item.username }} / {{ item.subdomain }}.{{ item.domain }}"
  when:
    - mariadb_create_users | bool
    - subdomain_db_passwords is defined
    - subdomain_entries | length > 0
  no_log: true
  tags: [mariadb, users]

# =============================================================================
# SAVE CREDENTIALS  (guarded by mariadb_save_credentials flag)
# =============================================================================

- name: Show status — save credentials
  ansible.builtin.debug:
    msg: >-
      mariadb_save_credentials={{ mariadb_save_credentials }}.
      {{ 'Credentials WILL be saved.' if mariadb_save_credentials
         else 'Skipping. Set mariadb_save_credentials: true to enable.' }}
  tags: [mariadb, credentials]

- name: Save domain database credentials to user home
  ansible.builtin.template:
    src: db-credentials.txt.j2
    dest: >-
      /home/{{ item.0.username }}/db-credentials-{{ item.1.domain
        | regex_replace('[^a-zA-Z0-9]', '_') }}.txt
    owner: "{{ item.0.username }}"
    group: "{{ item.0.username }}"
    mode: '0600'
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.username }} / {{ item.1.domain }}"
  when:
    - mariadb_save_credentials | bool
    - domain_db_passwords is defined
  tags: [mariadb, credentials]

- name: Save subdomain database credentials to user home
  ansible.builtin.template:
    src: db-credentials-subdomain.txt.j2
    dest: >-
      /home/{{ item.username }}/db-credentials-{{ item.subdomain }}-{{ item.domain
        | regex_replace('[^a-zA-Z0-9]', '_') }}.txt
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: '0600'
  loop: "{{ subdomain_entries }}"
  loop_control:
    label: "{{ item.username }} / {{ item.subdomain }}.{{ item.domain }}"
  when:
    - mariadb_save_credentials | bool
    - subdomain_db_passwords is defined
    - subdomain_entries | length > 0
  tags: [mariadb, credentials]

# =============================================================================
# PERFORMANCE TUNING  (guarded by mariadb_apply_config flag)
# =============================================================================

- name: Deploy MariaDB performance tuning config
  ansible.builtin.template:
    src: mariadb-custom.cnf.j2
    dest: /etc/my.cnf.d/99-custom.cnf
    owner: root
    group: root
    mode: '0644'
  when: mariadb_apply_config | bool
  notify: restart mariadb
  tags: [mariadb, config]

# =============================================================================
# FIREWALL
# =============================================================================

- name: Manage firewall rule for MySQL remote access
  ansible.posix.firewalld:
    service: mysql
    permanent: yes
    state: "{{ mariadb_allow_remote | bool | ternary('enabled', 'disabled') }}"
    immediate: yes
  when: ansible_facts.services['firewalld.service'] is defined
  tags: [mariadb, firewall]
