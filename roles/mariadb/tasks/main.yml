---
# tasks file for mariadb
# Purpose: Database automation per domain with conditional logic
#
# CONDITIONAL FLAGS (set in group_vars or host_vars):
#   mariadb_create_databases  — default: false
#   mariadb_create_users      — default: false
#   mariadb_save_credentials  — default: false
#   mariadb_apply_config      — default: true
#   mariadb_allow_remote      — default: false

# =============================================================================
# INSTALL & SERVICE
# =============================================================================

- name: Install MariaDB server
  ansible.builtin.dnf:
    name:
      - mariadb-server
      - mariadb
      - python3-PyMySQL
    state: present
  tags: [mariadb, install]

- name: Enable and start MariaDB service
  ansible.builtin.systemd:
    name: mariadb
    state: started
    enabled: yes
  tags: [mariadb, service]

# =============================================================================
# SECURITY HARDENING
# =============================================================================

- name: Check if MariaDB root password is already set
  ansible.builtin.command: mysql -u root -e "SELECT 1"
  register: mariadb_root_check
  changed_when: false
  failed_when: false
  tags: [mariadb, security]

- name: Set MariaDB root password (only when not yet set)
  community.mysql.mysql_user:
    name: root
    password: "{{ mariadb_root_password }}"
    login_unix_socket: /var/lib/mysql/mysql.sock
    state: present
  when: mariadb_root_check.rc == 0
  no_log: true
  tags: [mariadb, security]

- name: Deploy /root/.my.cnf for passwordless root CLI access
  ansible.builtin.template:
    src: my.cnf.j2
    dest: /root/.my.cnf
    owner: root
    group: root
    mode: '0600'
  no_log: true
  tags: [mariadb, security]

- name: Remove anonymous users
  community.mysql.mysql_user:
    name: ''
    host_all: yes
    state: absent
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  no_log: true
  tags: [mariadb, security]

- name: Remove test database
  community.mysql.mysql_db:
    name: test
    state: absent
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  tags: [mariadb, security]

- name: Disallow root login remotely
  community.mysql.mysql_query:
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    query: >
      DELETE FROM mysql.user
      WHERE User='root'
      AND Host NOT IN ('localhost', '127.0.0.1', '::1')
  no_log: true
  tags: [mariadb, security]

# =============================================================================
# DATABASE CREATION  (guarded by mariadb_create_databases flag)
# =============================================================================

- name: Show status — database creation
  ansible.builtin.debug:
    msg: >-
      mariadb_create_databases={{ mariadb_create_databases }}.
      {{ 'Databases WILL be created.' if mariadb_create_databases
         else 'Skipping database creation. Set mariadb_create_databases: true to enable.' }}
  tags: [mariadb, databases]

- name: Create database for each main domain
  community.mysql.mysql_db:
    name: "{{ item.0.username }}_{{ item.1.domain | regex_replace('[^a-zA-Z0-9]', '_') }}"
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    collation: utf8mb4_unicode_ci
    encoding: utf8mb4
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  # Guard: only run when the boolean flag is explicitly set to true
  when: mariadb_create_databases | bool
  tags: [mariadb, databases]

- name: Build list of domains with subdomains
  ansible.builtin.set_fact:
    user_domain_list: "{{ user_domain_list | default([]) + [{'user': item.0, 'domain': item.1, 'subdomains': item.1.subdomains}] }}"
  loop: "{{ hosting_users | subelements('domains') }}"
  when:
    - item.1.subdomains is defined
    - item.1.subdomains | length > 0
  tags: [mariadb, databases]

- name: Create database for each subdomain
  community.mysql.mysql_db:
    name: "{{ item.0.user.username }}_{{ item.1 }}_{{ item.0.domain.domain | regex_replace('[^a-zA-Z0-9]', '_') }}"
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    collation: utf8mb4_unicode_ci
    encoding: utf8mb4
  loop: "{{ user_domain_list | subelements('subdomains') }}"
  when: mariadb_create_databases | bool
  tags: [mariadb, databases]

# =============================================================================
# USER CREATION  (guarded by mariadb_create_users flag)
# =============================================================================

- name: Show status — user creation
  ansible.builtin.debug:
    msg: >-
      mariadb_create_users={{ mariadb_create_users }}.
      {{ 'Users WILL be created.' if mariadb_create_users
         else 'Skipping user creation. Set mariadb_create_users: true to enable.' }}
  tags: [mariadb, users]

# Generate passwords first (only when user creation is enabled)
- name: Generate database passwords for main domains
  ansible.builtin.set_fact:
    domain_db_passwords: >-
      {{ domain_db_passwords | default({}) | combine({
           item.0.username ~ '_' ~ item.1.domain:
             lookup('password', '/dev/null length=32 chars=ascii_letters,digits')
         }) }}
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  when: mariadb_create_users | bool
  no_log: true
  tags: [mariadb, users]

- name: Build list of domains with subdomains (for password generation)
  ansible.builtin.set_fact:
    user_domain_list_pw: "{{ user_domain_list_pw | default([]) + [{'user': item.0, 'domain': item.1, 'subdomains': item.1.subdomains}] }}"
  loop: "{{ hosting_users | subelements('domains') }}"
  when:
    - mariadb_create_users | bool
    - item.1.subdomains is defined
    - item.1.subdomains | length > 0
  tags: [mariadb, users]

- name: Generate database passwords for subdomains
  ansible.builtin.set_fact:
    subdomain_db_passwords: >-
      {{ subdomain_db_passwords | default({}) | combine({
           item.0.user.username ~ '_' ~ item.1 ~ '_' ~ item.0.domain.domain:
             lookup('password', '/dev/null length=32 chars=ascii_letters,digits')
         }) }}
  loop: "{{ user_domain_list_pw | subelements('subdomains') }}"
  no_log: true
  tags: [mariadb, users]

- name: Create database user for each main domain
  community.mysql.mysql_user:
    name: >-
      {{ (item.0.username ~ '_' ~ item.1.domain)
         | regex_replace('[^a-zA-Z0-9]', '_')
         | truncate(16, True, '') }}
    password: "{{ domain_db_passwords[item.0.username ~ '_' ~ item.1.domain] }}"
    priv: >-
      {{ item.0.username ~ '_' ~ (item.1.domain | regex_replace('[^a-zA-Z0-9]', '_')) }}.*:ALL
    host: localhost
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  when:
    - mariadb_create_users | bool
    - domain_db_passwords is defined
  no_log: true
  tags: [mariadb, users]

- name: Create database user for each subdomain
  community.mysql.mysql_user:
    name: >-
      {{ (item.0.user.username ~ '_' ~ item.1 ~ '_' ~ item.0.domain.domain)
         | regex_replace('[^a-zA-Z0-9]', '_')
         | truncate(16, True, '') }}
    password: "{{ subdomain_db_passwords[item.0.user.username ~ '_' ~ item.1 ~ '_' ~ item.0.domain.domain] }}"
    priv: >-
      {{ item.0.user.username ~ '_' ~ item.1 ~ '_' ~
         (item.0.domain.domain | regex_replace('[^a-zA-Z0-9]', '_')) }}.*:ALL
    host: localhost
    state: present
    login_user: root
    login_password: "{{ mariadb_root_password }}"
  loop: "{{ user_domain_list_pw | subelements('subdomains') }}"
  when:
    - mariadb_create_users | bool
    - subdomain_db_passwords is defined
  no_log: true
  tags: [mariadb, users]

# =============================================================================
# SAVE CREDENTIALS  (guarded by mariadb_save_credentials flag)
# =============================================================================

- name: Show status — save credentials
  ansible.builtin.debug:
    msg: >-
      mariadb_save_credentials={{ mariadb_save_credentials }}.
      {{ 'Credentials WILL be saved to user home dirs.' if mariadb_save_credentials
         else 'Skipping credential files. Set mariadb_save_credentials: true to enable.' }}
  tags: [mariadb, credentials]

- name: Save domain database credentials to user home
  ansible.builtin.template:
    src: db-credentials.txt.j2
    dest: >-
      /home/{{ item.0.username }}/db-credentials-{{ item.1.domain
        | regex_replace('[^a-zA-Z0-9]', '_') }}.txt
    owner: "{{ item.0.username }}"
    group: "{{ item.0.username }}"
    mode: '0600'
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  when:
    - mariadb_save_credentials | bool
    - domain_db_passwords is defined
  tags: [mariadb, credentials]

- name: Save subdomain database credentials to user home
  ansible.builtin.template:
    src: db-credentials-subdomain.txt.j2
    dest: >-
      /home/{{ item.0.user.username }}/db-credentials-{{ item.1 }}-{{ item.0.domain.domain
        | regex_replace('[^a-zA-Z0-9]', '_') }}.txt
    owner: "{{ item.0.user.username }}"
    group: "{{ item.0.user.username }}"
    mode: '0600'
  loop: "{{ user_domain_list_pw | subelements('subdomains') }}"
  when:
    - mariadb_save_credentials | bool
    - subdomain_db_passwords is defined
  tags: [mariadb, credentials]

# - name: Build list of user+domain objects with subdomains
#   ansible.builtin.set_fact:
#     user_domain_subdomains: >-
#       {{ user_domain_subdomains | default([]) +
#          [{'user': item.0,
#            'domain': item.1,
#            'subdomains': item.1.subdomains | default([])}] }}
#   loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
#   when:
#     - mariadb_save_credentials | bool
#     - subdomain_db_passwords is defined
#     - item.1.subdomains is defined
#     - item.1.subdomains | length > 0
#   tags: [mariadb, credentials, always]

# - name: Save subdomain database credentials to user home
#   ansible.builtin.template:
#     src: db-credentials-subdomain.txt.j2
#     dest: >-
#       /home/{{ item.0.user.username }}/db-credentials-{{ item.1 }}-{{
#         item.0.domain.domain | regex_replace('[^a-zA-Z0-9]', '_')
#       }}.txt
#     owner: "{{ item.0.user.username }}"
#     group: "{{ item.0.user.username }}"
#     mode: '0600'
#   loop: "{{ user_domain_subdomains | subelements('subdomains') }}"
#   when:
#     - mariadb_save_credentials | bool
#     - subdomain_db_passwords is defined
#   tags: [mariadb, credentials]

# =============================================================================
# PERFORMANCE TUNING  (guarded by mariadb_apply_config flag)
# =============================================================================

- name: Deploy MariaDB performance tuning config
  ansible.builtin.template:
    src: mariadb-custom.cnf.j2
    dest: /etc/my.cnf.d/99-custom.cnf
    owner: root
    group: root
    mode: '0644'
  when: mariadb_apply_config | bool
  notify: restart mariadb
  tags: [mariadb, config]

# =============================================================================
# FIREWALL
# =============================================================================

- name: Manage firewall rule for MySQL remote access
  ansible.posix.firewalld:
    service: mysql
    permanent: yes
    state: "{{ mariadb_allow_remote | bool | ternary('enabled', 'disabled') }}"
    immediate: yes
  when: ansible_facts.services['firewalld.service'] is defined
  tags: [mariadb, firewall]
