{%- set fqdn = domain -%}
{%- set php_ver_clean = php_version | replace('.', '') -%}
# VirtualHost for {{ fqdn }}
# User: {{ username }}
# Generated by Ansible

# ─────────────────────────────────────────────────────────────────────────────
# HTTP (Port 80)
# ─────────────────────────────────────────────────────────────────────────────

<VirtualHost *:80>
    ServerName {{ fqdn }}
    ServerAdmin webmaster@{{ domain }}

    DocumentRoot {{ document_root }}

    <Directory {{ document_root }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

{% if apache_enable_ssl | default(false) | bool %}
    # SSL is enabled — redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
{% else %}
    # PHP-FPM proxy configuration (HTTP only)
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/opt/remi/php{{ php_ver_clean }}/run/php-fpm/{{ username }}.sock|fcgi://localhost"
    </FilesMatch>
{% endif %}

    # Logging
    ErrorLog /var/log/httpd/{{ username }}-{{ domain }}-error.log
    CustomLog /var/log/httpd/{{ username }}-{{ domain }}-access.log combined
</VirtualHost>

{% if apache_enable_ssl | default(false) | bool %}
# ─────────────────────────────────────────────────────────────────────────────
# HTTPS (Port 443)
# ─────────────────────────────────────────────────────────────────────────────

<VirtualHost *:443>
    ServerName {{ fqdn }}
    ServerAdmin webmaster@{{ domain }}

    DocumentRoot {{ document_root }}

    <Directory {{ document_root }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # PHP-FPM proxy configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/opt/remi/php{{ php_ver_clean }}/run/php-fpm/{{ username }}.sock|fcgi://localhost"
    </FilesMatch>

    # SSL Configuration
    SSLEngine on

{% if apache_enable_letsencrypt | default(false) | bool %}
    # Let's Encrypt certificates
    SSLCertificateFile /etc/letsencrypt/live/{{ fqdn }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ fqdn }}/privkey.pem
{% elif apache_ssl_certificates is defined and fqdn in apache_ssl_certificates %}
    # Manual SSL certificate for this addon domain
    SSLCertificateFile {{ apache_ssl_certificates[fqdn].cert }}
    SSLCertificateKeyFile {{ apache_ssl_certificates[fqdn].key }}
{% if apache_ssl_certificates[fqdn].chain is defined %}
    SSLCertificateChainFile {{ apache_ssl_certificates[fqdn].chain }}
{% endif %}
{% elif apache_ssl_certificates is defined and domain in apache_ssl_certificates %}
    # Fallback to parent domain certificate (wildcard) – optional
    SSLCertificateFile {{ apache_ssl_certificates[domain].cert }}
    SSLCertificateKeyFile {{ apache_ssl_certificates[domain].key }}
{% if apache_ssl_certificates[domain].chain is defined %}
    SSLCertificateChainFile {{ apache_ssl_certificates[domain].chain }}
{% endif %}
{% else %}
    # Fallback to self-signed certificate
    SSLCertificateFile {{ apache_ssl_default_cert | default('/etc/pki/tls/certs/localhost.crt') }}
    SSLCertificateKeyFile {{ apache_ssl_default_key | default('/etc/pki/tls/private/localhost.key') }}
{% endif %}

    # SSL Protocol and Cipher
    SSLProtocol {{ apache_ssl_protocol | default('all -SSLv3 -TLSv1 -TLSv1.1') }}
    SSLCipherSuite {{ apache_ssl_cipher_suite | default('ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256') }}
    SSLHonorCipherOrder {{ apache_ssl_honor_cipher_order | default('Off') }}

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

{% if apache_hsts_enabled | default(true) | bool %}
    # HTTP Strict Transport Security (HSTS)
    Header always set Strict-Transport-Security "max-age={{ apache_hsts_max_age | default(31536000) }}{% if apache_hsts_include_subdomains | default(true) | bool %}; includeSubDomains{% endif %}{% if apache_hsts_preload | default(false) | bool %}; preload{% endif %}"
{% endif %}

    # Logging
    ErrorLog /var/log/httpd/{{ username }}-{{ domain }}-ssl-error.log
    CustomLog /var/log/httpd/{{ username }}-{{ domain }}-ssl-access.log combined
</VirtualHost>
{% endif %}
