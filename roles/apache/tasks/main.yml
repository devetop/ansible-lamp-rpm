---
# tasks file for apache
# Purpose: Web server provisioning and VirtualHost automation

- name: Install Apache HTTPD
  ansible.builtin.dnf:
    name:
      - httpd
      - httpd-tools
      - mod_ssl
    state: present
  tags: [apache, install]

- name: Enable required Apache modules
  ansible.builtin.lineinfile:
    path: /etc/httpd/conf.modules.d/00-base.conf
    line: "LoadModule {{ item }}_module modules/mod_{{ item }}.so"
    create: yes
  loop:
    - rewrite
    - headers
    - expires
  notify: restart apache
  tags: [apache, modules]

- name: Remove ssl.conf
  ansible.builtin.file:
    path: /etc/httpd/conf.d/ssl.conf
    state: absent
  tags: [apache, config]

- name: Create base Apache configuration
  ansible.builtin.template:
    src: httpd.conf.j2
    dest: /etc/httpd/conf/httpd.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
    validate: 'httpd -t -f %s'
  notify: restart apache
  tags: [apache, config]

- name: Create VirtualHost configuration directory
  ansible.builtin.file:
    path: /etc/httpd/sites-enabled
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [apache, config]

- name: Include VirtualHosts directory in main config
  ansible.builtin.lineinfile:
    path: /etc/httpd/conf/httpd.conf
    line: 'IncludeOptional sites-enabled/*.conf'
    insertafter: EOF
    state: present
  notify: restart apache
  tags: [apache, config]

- name: Create hosting users
  ansible.builtin.user:
    name: "{{ item.username }}"
    state: present
    create_home: yes
    home: "/home/{{ item.username }}"
    shell: /bin/bash
    groups: "{{ item.groups | default([]) }}"
  loop: "{{ hosting_users }}"
  tags: [apache, users]

- name: Create public_html directory for main domain
  ansible.builtin.file:
    path: "/home/{{ item.username }}/public_html"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: '0755'
  loop: "{{ hosting_users }}"
  tags: [apache, users, directories]

- name: Build list of all directories (subdomains and addons)
  ansible.builtin.set_fact:
    all_directory_entries: >-
      {%- set result = [] -%}
      {%- for user in hosting_users -%}
        {%- set user_default_php = user.php_versions | default([]) | first | default('8.1') -%}
        {%- for domain in user.domains | default([]) -%}
          {%- set domain_default_php = domain.php_version | default(user_default_php) -%}
          {# Proses subdomain #}
          {%- for sub in domain.subdomains | default([]) -%}
            {%- set sub_dir = sub if sub is string else sub.name -%}
            {%- if sub is mapping -%}
              {%- set sub_php = sub.php_version | default(domain_default_php) -%}
            {%- else -%}
              {%- set sub_php = domain_default_php -%}
            {%- endif -%}
            {%- set _ = result.append({
              'username':    user.username,
              'dir':         sub_dir,
              'type':        'subdomain',
              'domain':      domain.domain,
              'php_version': sub_php
            }) -%}
          {%- endfor -%}
          {# Proses addon domain #}
          {%- for addon in domain.addons | default([]) -%}
            {%- set addon_domain = addon if addon is string else addon.domain -%}
            {%- if addon is mapping -%}
              {%- set addon_php = addon.php_version | default(domain_default_php) -%}
            {%- else -%}
              {%- set addon_php = domain_default_php -%}
            {%- endif -%}
            {%- set _ = result.append({
              'username':    user.username,
              'dir':         addon_domain,
              'type':        'addon',
              'main_domain': domain.domain,
              'php_version': addon_php
            }) -%}
          {%- endfor -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ result }}
  tags: [apache, users, directories, vhosts]

- name: Create directories for subdomains and addons
  ansible.builtin.file:
    path: "/home/{{ item.username }}/{{ item.dir }}"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: '0755'
  loop: "{{ all_directory_entries }}"
  loop_control:
    label: "/home/{{ item.username }}/{{ item.dir }}"
  when: all_directory_entries | length > 0
  tags: [apache, users, directories]

- name: Set SELinux context for web content directories
  community.general.sefcontext:
    target: "/home/{{ item.username }}(/.*)?"
    setype: httpd_sys_content_t
    state: present
  loop: "{{ hosting_users }}"
  tags: [apache, selinux]

- name: Apply SELinux contexts immediately
  ansible.builtin.command: "restorecon -Rv /home/{{ item.username }}"
  loop: "{{ hosting_users }}"
  changed_when: false
  tags: [apache, selinux]

- name: Set SELinux context for user public_html directories (pattern regex)
  community.general.sefcontext:
    target: '/home/{{ item.username }}/public_html(/.*)?'
    setype: httpd_sys_rw_content_t
    state: present
  loop: "{{ hosting_users }}"
  tags: [apache, selinux]

- name: Apply the SELinux context to each user's public_html directory
  ansible.builtin.command: "restorecon -Rv /home/{{ item.username }}/public_html"
  loop: "{{ hosting_users }}"
  changed_when: false
  tags: [apache, selinux]

- name: Set SELinux context for each created directory (subdomains and addons)
  community.general.sefcontext:
    target: "/home/{{ item.username }}/{{ item.dir }}(/.*)?"
    setype: httpd_sys_rw_content_t
    state: present
  loop: "{{ all_directory_entries }}"
  loop_control:
    label: "Set context for /home/{{ item.username }}/{{ item.dir }}"
  when: all_directory_entries | length > 0
  changed_when: false
  notify: restorecon home directories
  tags: [apache, selinux]

- name: Apply the SELinux context to each created directory (subdomains and addons)
  ansible.builtin.command: "restorecon -Rv '/home/{{ item.username }}/{{ item.dir }}'"
  loop: "{{ all_directory_entries }}"
  loop_control:
    label: "Restorecon /home/{{ item.username }}/{{ item.dir }}"
  when: all_directory_entries | length > 0
  changed_when: false
  tags: [apache, selinux]

- name: Allow Apache to connect to network (for proxying to PHP-FPM)
  ansible.posix.seboolean:
    name: httpd_can_network_connect
    state: yes
    persistent: yes
  tags: [apache, selinux]

- name: Allow Apache to read user content
  ansible.posix.seboolean:
    name: httpd_read_user_content
    state: yes
    persistent: yes
  tags: [apache, selinux]

- name: Allow Apache to read home directories
  ansible.posix.seboolean:
    name: httpd_enable_homedirs
    state: yes
    persistent: yes
  tags: [apache, selinux]

# - name: Allow Apache to execute memory
#   ansible.posix.seboolean:
#     name: httpd_execmem
#     state: yes
#     persistent: yes
#   tags: [apache, selinux]

- name: Generate VirtualHost for main domains
  ansible.builtin.template:
    src: vhost-main.conf.j2
    dest: "/etc/httpd/sites-enabled/{{ item.0.username }}-{{ item.1.domain | replace('.', '_') }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ hosting_users | subelements('domains', skip_missing=True) }}"
  vars:
    username: "{{ item.0.username }}"
    domain: "{{ item.1.domain }}"
    user_default_php: "{{ item.0.php_versions[0] | default('8.1') }}"
    php_version: "{{ item.1.php_version | default(user_default_php) }}"
    document_root: "/home/{{ item.0.username }}/public_html"
  notify: restart apache
  tags: [apache, vhosts]

# =============================================================================
# Generate VirtualHost untuk subdomain
# =============================================================================
- name: Generate VirtualHost for subdomains
  ansible.builtin.template:
    src: vhost-subdomain.conf.j2
    dest: "/etc/httpd/sites-enabled/{{ item.username }}-{{ item.dir }}.{{ item.domain | replace('.', '_') }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ all_directory_entries | selectattr('type', '==', 'subdomain') | list }}"
  loop_control:
    label: "{{ item.username }}-{{ item.dir }}.{{ item.domain }}"
  vars:
    username: "{{ item.username }}"
    domain: "{{ item.domain }}"
    subdomain: "{{ item.dir }}"
    php_version: "{{ item.php_version }}"
    document_root: "/home/{{ item.username }}/{{ item.dir }}"
  notify: restart apache
  tags: [apache, vhosts]

# =============================================================================
# Generate VirtualHost untuk addon domain
# =============================================================================
- name: Generate VirtualHost for addon domains
  ansible.builtin.template:
    src: vhost-addon.conf.j2
    dest: "/etc/httpd/sites-enabled/{{ item.username }}-{{ item.dir | replace('.', '_') }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ all_directory_entries | selectattr('type', '==', 'addon') | list }}"
  loop_control:
    label: "{{ item.username }}-{{ item.dir }}"
  vars:
    username: "{{ item.username }}"
    domain: "{{ item.dir }}"
    php_version: "{{ item.php_version }}"
    document_root: "/home/{{ item.username }}/{{ item.dir }}"
    main_domain: "{{ item.main_domain | default('') }}"
  notify: restart apache
  tags: [apache, vhosts]

- name: Set proper ACLs for Apache access
  ansible.posix.acl:
    path: "/home/{{ item.username }}"
    entity: apache
    etype: user
    permissions: rx
    state: present
  loop: "{{ hosting_users }}"
  tags: [apache, acl]

- name: Enable and start Apache service
  ansible.builtin.systemd:
    name: httpd
    state: started
    enabled: yes
  tags: [apache, service]

# =============================================================================
# SSL / TLS SETUP
# =============================================================================

- name: Install mod_ssl
  ansible.builtin.dnf:
    name: mod_ssl
    state: present
  when: apache_enable_ssl | bool
  notify: restart apache
  tags: [apache, ssl, install]

# ─────────────────────────────────────────────────────────────────────────────
# OPTION A: MANUAL SSL CERTIFICATES
# ─────────────────────────────────────────────────────────────────────────────

- name: Validate manual SSL certificate paths exist
  ansible.builtin.stat:
    path: "{{ item.value.cert }}"
  loop: "{{ apache_ssl_certificates | dict2items }}"
  loop_control:
    label: "{{ item.key }} → {{ item.value.cert }}"
  register: _ssl_cert_check
  when:
    - apache_enable_ssl | bool
    - not apache_enable_letsencrypt | bool
    - apache_ssl_certificates | length > 0
  failed_when: not _ssl_cert_check.stat.exists
  tags: [apache, ssl, validate]

- name: Validate manual SSL key paths exist
  ansible.builtin.stat:
    path: "{{ item.value.key }}"
  loop: "{{ apache_ssl_certificates | dict2items }}"
  loop_control:
    label: "{{ item.key }} → {{ item.value.key }}"
  register: _ssl_key_check
  when:
    - apache_enable_ssl | bool
    - not apache_enable_letsencrypt | bool
    - apache_ssl_certificates | length > 0
  failed_when: not _ssl_key_check.stat.exists
  tags: [apache, ssl, validate]

# ─────────────────────────────────────────────────────────────────────────────
# OPTION B: LET'S ENCRYPT (CERTBOT)
# ─────────────────────────────────────────────────────────────────────────────

- name: Validate Let's Encrypt email is set
  ansible.builtin.assert:
    that:
      - apache_letsencrypt_email | length > 0
      - "'@' in apache_letsencrypt_email"
    fail_msg: |
      apache_letsencrypt_email must be set when apache_enable_letsencrypt: true.
      Set it in group_vars or host_vars.
    success_msg: "Let's Encrypt email: {{ apache_letsencrypt_email }}"
  when:
    - apache_enable_ssl | bool
    - apache_enable_letsencrypt | bool
  tags: [apache, ssl, letsencrypt]

- name: Install Certbot and Apache plugin
  ansible.builtin.dnf:
    name:
      - certbot
      - python3-certbot-apache
    state: present
  when:
    - apache_enable_ssl | bool
    - apache_enable_letsencrypt | bool
  tags: [apache, ssl, letsencrypt, install]

- name: Build list of domains for Let's Encrypt
  ansible.builtin.set_fact:
    _letsencrypt_domains: >-
      {%- set result = [] -%}
      {%- for user in hosting_users -%}
        {%- for dom in user.domains | default([]) -%}
          {%- set _ = result.append(dom.domain) -%}
          {%- for sub in dom.subdomains | default([]) -%}
            {%- set _ = result.append(sub ~ '.' ~ dom.domain) -%}
          {%- endfor -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ result | unique }}
  when:
    - apache_enable_ssl | bool
    - apache_enable_letsencrypt | bool
  tags: [apache, ssl, letsencrypt]

- name: Request Let's Encrypt certificates
  ansible.builtin.command:
    cmd: >
      certbot certonly --apache --non-interactive
      --agree-tos --email {{ apache_letsencrypt_email }}
      {% if apache_certbot_staging %}--staging{% endif %}
      --domain {{ item }}
      --deploy-hook "{{ apache_certbot_renew_hook }}"
    creates: "/etc/letsencrypt/live/{{ item }}/fullchain.pem"
  loop: "{{ _letsencrypt_domains }}"
  loop_control:
    label: "{{ item }}"
  when:
    - apache_enable_ssl | bool
    - apache_enable_letsencrypt | bool
    - _letsencrypt_domains | length > 0
  tags: [apache, ssl, letsencrypt]

- name: Enable Certbot renewal timer
  ansible.builtin.systemd:
    name: certbot-renew.timer
    state: started
    enabled: true
  when:
    - apache_enable_ssl | bool
    - apache_enable_letsencrypt | bool
  tags: [apache, ssl, letsencrypt]

- name: Configure firewall for HTTP/HTTPS
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop:
    - http
    - https
  when: ansible_facts.services['firewalld.service'] is defined
  tags: [apache, firewall]

- name: Test Apache configuration
  ansible.builtin.command: httpd -t
  register: apache_config_test
  changed_when: false
  failed_when: apache_config_test.rc != 0
  tags: [apache, test]
